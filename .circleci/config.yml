version: 2
jobs:
  test:
    docker:
      - image: marratj/pipeline-tools:0.5
    steps:
      - checkout
      - run: mkdir -p plan
      - run: terraform init -backend-config="$BACKEND_STORAGE_ACCOUNT_NAME" -backend-config="$BACKEND_RESOURCE_GROUP_NAME" -backend-config="$BACKEND_CONTAINER_NAME" -backend-config="$BACKEND_KEY"
      - run: terraform plan -out=plan/kthwplan
      - persist_to_workspace:
          root: plan
          paths:
            - kthwplan
  deploy:
    docker:
      - image: marratj/pipeline-tools:0.5
    steps:
      - checkout
      - attach_workspace:
          at: plan
      - run: terraform init -backend-config="$BACKEND_STORAGE_ACCOUNT_NAME" -backend-config="$BACKEND_RESOURCE_GROUP_NAME" -backend-config="$BACKEND_CONTAINER_NAME" -backend-config="$BACKEND_KEY"
      - run: terraform apply plan/kthwplan

workflows:
  version: 2
  kthw-terraform:
    jobs:
      - test
      - deploy:
          requires:
            - test
          filters:
            branches:
              only: master
